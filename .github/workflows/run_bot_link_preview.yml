name: Run Discord Bot (with Link Preview)

on:
  schedule:
    # 每天的 UTC 時間 0, 4, 8, 12, 16, 20 點執行
    # 對應台灣時間 (UTC+8) 的 08, 12, 16, 20, 00, 04 點
    # 若您希望是對應「台灣時間」的 0, 4, 8...，由於 cron 使用 UTC，
    # 台灣時間 00:00 = UTC 16:00 (前一天)
    # 台灣時間 04:00 = UTC 20:00 (前一天)
    # 台灣時間 08:00 = UTC 00:00
    # 台灣時間 12:00 = UTC 04:00
    # 台灣時間 16:00 = UTC 08:00
    # 台灣時間 20:00 = UTC 12:00
    # 因為間隔剛好是 4 小時，且 8 是 4 的倍數，所以 cron 表達式剛好一樣都是 0,4,8,12,16,20
    - cron: "3 0,2,4,6,8,10,12,14,16,18,20,22 * * *"

  # 允許手動從 Actions 頁面觸發
  workflow_dispatch:
    inputs:
      force_ai_summary:
        description: "強制執行 AI 總結"
        required: false
        default: false
        type: boolean
      force_daily_quote:
        description: "強制執行 每日金句"
        required: false
        default: false
        type: boolean
      force_daily_ai_summary:
        description: "強制執行 每日摘要彙整"
        required: false
        default: false
        type: boolean
      force_link_screenshot:
        description: "強制執行 連結截圖"
        required: false
        default: false
        type: boolean
      force_weather_forecast:
        description: "強制執行 天氣預報"
        required: false
        default: false
        type: boolean

jobs:
  run-bot:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: TCC
        run: |
          sudo python3 tcc.py

      - name: Run Bot Script
        env:
          # 請記得去 GitHub Repo Settings -> Secrets and variables -> Actions 加入這些 Secrets
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SOURCE_CHANNEL_IDS: ${{ secrets.SOURCE_CHANNEL_IDS }}
          TARGET_CHANNEL_ID: ${{ secrets.TARGET_CHANNEL_ID }}
          TARGET_PREVIEW_ID: ${{ secrets.TARGET_PREVIEW_ID }}
          FORCE_AI_SUMMARY: ${{ github.event.inputs.force_ai_summary || 'false' }}
          FORCE_DAILY_QUOTE: ${{ github.event.inputs.force_daily_quote || 'false' }}
          FORCE_DAILY_AI_SUMMARY: ${{ github.event.inputs.force_daily_ai_summary || 'false' }}
          FORCE_LINK_SCREENSHOT: ${{ github.event.inputs.force_link_screenshot || 'false' }}
          FORCE_WEATHER_FORECAST: ${{ github.event.inputs.force_weather_forecast || 'false' }}
          WEATHER_KEY: ${{ secrets.WEATHER_KEY }}
          TARGET_WEATHER_ID: ${{ secrets.TARGET_WEATHER_ID }}
          PYTHONUNBUFFERED: "1"
        run: |
          python server.py
